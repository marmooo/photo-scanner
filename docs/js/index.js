function clearConfig(){localStorage.clear()}function loadConfig(){const e=document.getElementById("config"),t=localStorage.getItem("resolution");t&&(e.resolution.options[t].selected=!0),e.filter.value=localStorage.getItem("filter"),document.getElementById("clientId").value=localStorage.getItem("clientId"),document.getElementById("serverAddress").value=localStorage.getItem("serverAddress"),localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark"),localStorage.getItem("overview")==0&&(document.getElementById("overview").hidden=!0)}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}function deleteThumbnails(){for(;outputElement.firstChild;)outputElement.removeChild(outputElement.lastChild)}function downloadThumbnails(){for(let t=0;t<outputElement.children.length;t++){const e=document.createElement("a");e.download=t+".jpg",e.href=outputElement.children[t].shadowRoot.querySelector("img").src,outputElement.appendChild(e),e.click(),outputElement.removeChild(e)}}function uploadDropbox(){const e=parseQueryString(location.hash),t=document.getElementById("clientId").value;if(t!=""&&e&&e.accessToken){const t=new Dropbox.Dropbox({fetch,accessToken:e.access_token});for(let e=0;e<outputElement.children.length;e++){const n="/"+e+".jpg",s=outputElement.children[e].shadowRoot.querySelector("img").src;t.filesUpload({path:n,contents:base64ToArrayBuffer(s)}).then(()=>{}).catch(e=>{console.log(e),alert(e.error.error_summary)})}}else{const e=document.getElementById("dropboxAlert");e.hidden=!1,e.scrollIntoView()}}function base64ToArrayBuffer(e){e=e.slice(e.indexOf("base64,")+7);const t=globalThis.atob(e),n=t.length,s=new Uint8Array(n);for(let e=0;e<n;e++)s[e]=t.charCodeAt(e);return s.buffer}function base64toJpg(e){const t=atob(e.replace(/^.*,/,"")),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return new Blob([n.buffer],{type:"image/jpeg"})}function uploadServer(){const e=document.getElementById("serverAddress").value,t=new FormData;if(e!=""){for(let n=0;n<outputElement.children.length;n++){let e=outputElement.children[n].shadowRoot.querySelector("img").src;console.log(e),e=e.slice(e.indexOf("base64,")+7),console.log(e),t.append("files",base64toJpg(e),n+".jpg")}fetch(e,{method:"POST",body:t,mode:"no-cors"}).then(()=>{}).catch(e=>{console.log(e),alert(e)})}else{const e=document.getElementById("serverAlert");e.hidden=!1,e.scrollIntoView()}}function parseQueryString(e){const t=Object.create(null);return typeof e!="string"?t:(e=e.trim().replace(/^(\?|#|&)/,""),e?(e.split("&").forEach(e=>{const o=e.replace(/\+/g," ").split("=");let n=o.shift(),s=o.length>0?o.join("="):void 0;n=decodeURIComponent(n),s=s===void 0?null:decodeURIComponent(s),t[n]===void 0?t[n]=s:Array.isArray(t[n])?t[n].push(s):t[n]=[t[n],s]}),t):t)}document.getElementById("reloadApp").addEventListener("click",t=>{e.preventDefault();const n=t.currentTarget.dataset.href,s=document.getElementById("clientId").value;location.href=n+"&client_id="+s});class ImageBox extends HTMLElement{constructor(){super();const e=document.getElementById("img-box").content.cloneNode(!0);e.querySelector("img").onclick=e=>{const t=document.getElementById("previewImage");t.src=e.currentTarget.src,t.width=e.target.naturalWidth,t.height=e.target.naturalHeight,previewModal.show()},e.querySelector(".close").onclick=e=>{e.currentTarget.parentNode.parentNode.parentNode.host.remove()},e.querySelector(".rotate").onclick=e=>{const n=e.currentTarget.parentNode.parentNode,t=n.querySelector("img"),s=(parseInt(t.dataset.angle)+90)%360;s%180==0?(n.style.width=t.width+"px",n.style.height=t.height+"px"):(n.style.width=t.height+"px",n.style.height=t.width+"px"),t.className="rotate"+s,t.dataset.angle=s},this.attachShadow({mode:"open"}).appendChild(e)}}customElements.define("img-box",ImageBox);function initializeEvents(){const t=document.getElementsByClassName("event-close");for(let e=0;e<t.length;e++)t[e].addEventListener("click",e=>{const t=e.currentTarget.getAttribute("data-bs-target");document.querySelector(t).hidden=!0});const n=document.getElementsByClassName("event-open");for(let e=0;e<n.length;e++)n[e].addEventListener("click",e=>{const t=e.currentTarget.getAttribute("data-bs-target");document.querySelector(t).hidden=!1});const e=document.getElementById("lang");e.onchange=()=>{const t=e.options[e.selectedIndex].value;location.href="/photo-scanner/"+t}}initializeEvents();let animationFrame,lastAnimated=0;const snapCanvas=document.getElementById("snapCanvas"),uploadCanvas=document.getElementById("uploadCanvas"),video=document.createElement("video"),videoOptions={video:{facingMode:"environment"}},videoCanvas=document.getElementById("videoCanvas"),videoCanvasContext=videoCanvas.getContext("2d"),loadingMessage=document.getElementById("loadingMessage"),outputElement=document.getElementById("output");navigator.mediaDevices.getUserMedia===void 0&&(navigator.mediaDevices.getUserMedia=e=>{const t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t?new Promise((n,s)=>{t.call(navigator,e,n,s)}):Promise.reject(new Error("getUserMedia is not implemented in this browser"))}),cv.then(e=>{document.getElementById("snapshot").onclick=m,document.getElementById("clipboard").onclick=v,document.getElementById("selectImages").onclick=()=>{document.getElementById("inputImages").click()};function t(e,t){uploadCanvas.hidden=!0,e.srcObject&&e.srcObject.getVideoTracks().forEach(e=>{e.stop()}),navigator.mediaDevices.getUserMedia(t).then(t=>{videoCanvas.hidden=!1,e.srcObject=t,e.setAttribute("playsinline",!0),e.play(),loadingMessage.textContent="⌛ Loading video...",animationFrame=requestAnimationFrame(o)}).catch(e=>{})}t(video,videoOptions),document.getElementById("facingMode").onclick=()=>{videoOptions.video.facingMode=="user"?videoOptions.video.facingMode="environment":videoOptions.video.facingMode="user",t(video,videoOptions)},document.getElementById("inputImages").onchange=e=>{loadingMessage.hidden=!1,loadingMessage.textContent="⌛ Loading image...",cancelAnimationFrame(animationFrame),uploadCanvas.hidden=!1,videoCanvas.hidden=!0;const t=e.currentTarget.files;for(let e=0;e<t.length;e++)if(t[e].type.startsWith("image/")){t[e].type.startsWith("image/svg")&&alert("Sorry, SVG is probably not convertible.");const s=URL.createObjectURL(t[e]);n(uploadCanvas,s)}};function g(t){const s=e.imread(t),n=new e.Mat;e.resize(s,n,new e.Size(t.width/2,t.height/2),0,0,e.INTER_NEAREST);const o=i(n);o.total()==4?(e.imshow("videoCanvas",n),document.getElementById("snapshot").style.fill="blue"):document.getElementById("snapshot").style.fill="black",o.delete(),s.delete(),n.delete()}function o(){const t=30,e=Date.now();lastAnimated+1e3/t<e&&(lastAnimated=e,video.readyState===video.HAVE_ENOUGH_DATA&&(loadingMessage.hidden=!0,videoCanvas.width=video.videoWidth,videoCanvas.height=video.videoHeight,videoCanvasContext.drawImage(video,0,0,videoCanvas.width,videoCanvas.height),g(videoCanvas))),animationFrame=requestAnimationFrame(o)}function j(e){const t=[e[0]+e[1],e[2]+e[3],e[4]+e[5],e[6]+e[7]];let r=t[0],c=t[0],s=0,o=0;for(let e=1;e<4;e++)c<t[e]&&(c=t[e],o=e),r>t[e]&&(r=t[e],s=e);const l=[s,o],n=[0,1,2,3].filter(e=>!l.includes(e));let i,a;return e[n[0]*2]<e[n[1]*2]?(i=n[0],a=n[1]):(i=n[1],a=n[0]),[e[s*2],e[s*2+1],e[i*2],e[i*2+1],e[o*2],e[o*2+1],e[a*2],e[a*2+1]]}function i(t){const n=e.Mat.zeros(t.rows,t.cols,e.CV_8UC3);e.cvtColor(t,n,e.COLOR_RGBA2GRAY,0);const d=(n.rows+n.cols)/8*2+1;e.adaptiveThreshold(n,n,255,e.ADAPTIVE_THRESH_GAUSSIAN_C,e.THRESH_BINARY,d,0);const s=new e.MatVector,i=new e.Mat;e.findContours(n,s,i,e.RETR_EXTERNAL,e.CHAIN_APPROX_SIMPLE),n.delete();let c=0,l=0;for(let t=0;t<s.size();t++){const n=s.get(t),o=e.contourArea(n,!1);l<o&&(l=o,c=t),n.delete()}const a=s.get(c);s.delete();const r=new e.MatVector,o=new e.Mat;if(e.approxPolyDP(a,o,.05*e.arcLength(a,!0),!0),r.push_back(o),o.total()==4){const n=new e.Scalar(255,255,255,0);e.drawContours(t,r,0,n,4,e.LINE_8,i,0)}return i.delete(),a.delete(),r.delete(),o}function b(t,n){const s=i(t);if(s.total()==4){const a=s.data32S.slice(0,8),d=e.matFromArray(4,1,e.CV_32FC2,a),[o,i]=p(a,t.rows,t.cols),u=new e.Size(o,i),h=e.matFromArray(4,1,e.CV_32FC2,[0,0,0,i,o,i,o,0]),r=e.getPerspectiveTransform(d,h);e.warpPerspective(t,t,r,u,e.INTER_LINEAR,e.BORDER_CONSTANT,new e.Scalar),r.delete(),n=="1"?c(t):n=="2"&&l(t)}e.imshow("snapCanvas",t),s.delete()}function p(e,t,n){const s=h();if(s==0){const s=Math.sqrt((e[0]-e[2])**2+(e[1]-e[3])**2),o=Math.sqrt((e[2]-e[4])**2+(e[3]-e[5])**2),i=Math.sqrt((e[4]-e[6])**2+(e[5]-e[7])**2),a=Math.sqrt((e[6]-e[0])**2+(e[7]-e[2])**2),r=o+a,c=s+i;n=Math.round(t/r*c)}else t>n?n=t/s:t=n*s;return[t,n]}function c(t){const n=new e.MatVector,s=new e.MatVector;e.split(t,n);for(let i=0;i<3;i++){const t=n.get(i),o=new e.Mat,a=e.Mat.ones(7,7,e.CV_8U),c=new e.Point(-1,-1);e.dilate(t,o,a,c,1,e.BORDER_CONSTANT,e.morphologyDefaultBorderValue()),e.medianBlur(o,o,21);const l=new e.Scalar(255,255,255,0),r=new e.Mat(t.rows,t.cols,e.CV_8UC1,l);e.absdiff(t,o,o),e.subtract(r,o,t),e.normalize(t,t,alpha=0,beta=255,norm_type=e.NORM_MINMAX),s.push_back(t),t.delete(),a.delete(),o.delete(),r.delete()}return e.merge(s,t),n.delete(),s.delete(),t}let s;tf.loadLayersModel("/photo-scanner/denoise/model.json").then(e=>{s=e});function l(t){try{const n=new e.Mat;e.resize(t,n,new e.Size(256,256),0,0,e.INTER_NEAREST);const o=tf.tidy(()=>{const c=3;e.cvtColor(n,n,e.COLOR_RGBA2RGB,0);let a=tf.tensor3d(new Uint8Array(n.data),[n.rows,n.cols,c]).expandDims(0).toFloat();a=tf.cast(a,"float32").div(tf.scalar(255));const o=s.predict(a).mul(tf.scalar(255)).dataSync(),i=new Uint8ClampedArray(n.rows*n.cols*4);for(let e=0;e<o.length;e+=3){const t=e*3/4;i[t]=o[e],i[t+1]=o[e+1],i[t+2]=o[e+2],i[t+3]=0}const l=new ImageData(i,256,256),r=e.matFromImageData(l);return e.resize(r,r,new e.Size(t.rows,t.cols),0,0,e.INTER_NEAREST),e.absdiff(t,t,r),n.delete(),o});return o}catch(e){alert(e),console.log(e)}}function d(){const n=document.getElementById("config"),s=parseInt(n.resolution.value)*1e3,e=videoCanvas.width/videoCanvas.height,t=Math.sqrt(s/e);return[t*e,t]}function u(){const e=document.getElementById("config");return e.filter.value}function h(){const t=document.getElementById("config");let e=parseFloat(t.ratio.value);return e==-1&&(e=document.getElementById("ratioValue").value),e}function m(){if(video.srcObject){new Audio("camera.mp3").play();const[e,t]=d(),n={video:{facingMode:"environment",width:{min:0,max:e},height:{min:0,max:t},aspectRatio:e/t}};f(video,n)}}function f(e,t){uploadCanvas.hidden=!0,e.srcObject&&e.srcObject.getVideoTracks().forEach(e=>{e.stop()}),navigator.mediaDevices.getUserMedia(t).then(t=>{e.srcObject=t,e.setAttribute("playsinline",!0),e.play(),animationFrame=requestAnimationFrame(r)}).catch(e=>{})}function r(){if(video.readyState===video.HAVE_ENOUGH_DATA){videoCanvas.width=video.videoWidth,videoCanvas.height=video.videoHeight,videoCanvasContext.drawImage(video,0,0,videoCanvas.width,videoCanvas.height),a(videoCanvas),t(video,videoOptions);return}animationFrame=requestAnimationFrame(r)}function n(e,t){const n=new Image;n.onload=()=>{loadingMessage.hidden=!0,e.width=n.naturalWidth,e.height=n.naturalHeight,e.getContext("2d").drawImage(n,0,0,e.width,e.height),a(e)},n.src=t}function v(){try{loadingMessage.textContent="⌛ Loading image...",loadingMessage.hidden=!1,navigator.clipboard.read().then(e=>{for(let t=0;t<e.length;t++){const s=e[t];for(let e=0;e<s.types.length;e++){const t=s.types[e];t.indexOf("image/")!=-1&&(t.startsWith("image/svg")&&alert("Sorry, SVG is probably not convertible."),s.getType(t).then(e=>{cancelAnimationFrame(animationFrame),uploadCanvas.hidden=!1,videoCanvas.hidden=!0;const t=URL.createObjectURL(e);n(uploadCanvas,t)}))}}})}finally{loadingMessage.hidden=!0}}document.body.onpaste=e=>{loadingMessage.textContent="⌛ Loading image...",loadingMessage.hidden=!1;const t=(e.clipboardData||e.originalEvent.clipboardData).items;let s;for(let e=0;e<t.length;e++)t[e].type.indexOf("image")===0&&(s=t[e].getAsFile());if(s!==null){const e=new FileReader;e.onload=e=>{cancelAnimationFrame(animationFrame),uploadCanvas.hidden=!1,videoCanvas.hidden=!0;const t=e.currentTarget.result;n(uploadCanvas,t)},e.readAsDataURL(s)}loadingMessage.hidden=!0};function a(t){const n=e.imread(t);b(n,u()),e.imshow("snapCanvas",n),n.delete();const s=document.createElement("img-box"),o=s.shadowRoot.querySelector("img");o.src=snapCanvas.toDataURL("image/jpg"),o.height=150/snapCanvas.width*snapCanvas.height,outputElement.append(s)}}).catch(e=>{alert(e)}),loadConfig();const tooltipTriggerList=[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));tooltipTriggerList.map(e=>new bootstrap.Tooltip(e));const previewModal=new bootstrap.Modal(document.getElementById("previewModal"));document.getElementById("config").addEventListener("change",e=>{const t=e.currentTarget.name;switch(t){case"resolution":localStorage.setItem(t,e.currentTarget.selectedIndex);break;case"filter":case"clientId":case"serverAddress":localStorage.setItem(t,e.currentTarget.value);break}}),document.getElementById("overview").addEventListener("click",()=>{localStorage.setItem("overview",0)}),document.getElementById("clearConfig").onclick=clearConfig,document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("deleteThumbnails").onclick=deleteThumbnails,document.getElementById("downloadThumbnails").onclick=downloadThumbnails,document.getElementById("uploadDropbox").onclick=uploadDropbox,document.getElementById("uploadServer").onclick=uploadServer